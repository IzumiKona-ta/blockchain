ä»£ç è¯æ® 1ï¼šå¨èƒå‘Šè­¦æ•°æ®æ¨¡å‹å®šä¹‰ (æ¥æºï¼šsrc/main/java/com/example/blockchain/dto/ThreatAlertDTO.java)

Java

```java
@Data
public class ThreatAlertDTO {
    // ä¸šåŠ¡ä¸»é”®ï¼Œç”¨äºé“¾ä¸Šç´¢å¼•
    private Integer id;
    private String threatId;     // å¨èƒå”¯ä¸€æ ‡è¯†
    
    // æ ¸å¿ƒå®‰å…¨å±æ€§
    private Integer threatLevel; // å¨èƒç­‰çº§
    private String impactScope;  // å½±å“èŒƒå›´
    
    // æ—¶é—´æˆ³ï¼Œç¡®ä¿è¯æ®æ—¶æ•ˆæ€§
    private String occurTime;
    private String createTime;
    
    // ... Getter/Setter ...
}
```
ä»£ç è¯æ® 2ï¼šä¸“ç”¨å­˜è¯æ¥å£å°è£… (æ¥æºï¼šsrc/main/java/com/example/blockchain/BlockchainController.java)

Java

```java
// å¨èƒå‘Šè­¦ä¸“ç”¨ä¸Šé“¾æ¥å£
@PostMapping("/chain/alert")
public Map<String, Object> submitAlert(@RequestBody ThreatAlertDTO dto) {
    // ä¼˜å…ˆä½¿ç”¨ threatId ä½œä¸ºå”¯ä¸€åŒºå—é“¾é”®å€¼(Key)ï¼Œå®ç°ä¸šåŠ¡ä¸åŒºå—é“¾çš„ç»‘å®š
    String key = dto.getThreatId() != null ? dto.getThreatId() : String.valueOf(dto.getId());
    
    // è°ƒç”¨é€šç”¨å¤„ç†é€»è¾‘ï¼Œè‡ªåŠ¨è®¡ç®—å“ˆå¸Œå¹¶å…¥é˜Ÿ
    return processRequest("ALERT_" + key, JSON.toJSONString(dto));
}
```
2. æŠ€æœ¯ç‚¹ï¼šé«˜å¹¶å‘å­˜è¯ä¸ç³»ç»Ÿååé‡ä¼˜åŒ–
å•†ä¸šè®¡åˆ’ä¹¦å¯¹åº”ï¼šâ€œé«˜æ•ˆã€æ™ºèƒ½...åº”å¯¹ç½‘ç»œç©ºé—´æ—¥ç›Šå¤æ‚çš„å®‰å…¨å¨èƒâ€ã€‚ï¼ˆéšå«äº†å¯¹æµ·é‡æ—¥å¿—å¤„ç†æ€§èƒ½çš„è¦æ±‚ï¼‰ ä»£ç å®ç°ï¼šè‡ªä¸»ç ”å‘çš„ å¼‚æ­¥å¾®æœåŠ¡æ¶æ„ï¼Œé‡‡ç”¨å†…å­˜æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²ä¸šåŠ¡è¯·æ±‚ï¼Œå¹¶å®ç° æ‰¹é‡ä¸Šé“¾ (Batching) æœºåˆ¶ï¼Œå°† TPS æå‡æ•°å€ã€‚

ä»£ç è¯æ®ï¼šå¼‚æ­¥æ‰¹é‡å¤„ç†å¼•æ“ (æ¥æºï¼šsrc/main/java/com/example/blockchain/service/AsyncService.java)

Java

```java
@Service
public class AsyncService {
    // 1. é«˜æ€§èƒ½å†…å­˜é˜Ÿåˆ—ï¼Œå®ç°â€œå‰Šå³°å¡«è°·â€ï¼Œè§£è€¦ä¸šåŠ¡ç«¯ä¸åŒºå—é“¾ç«¯
    private final BlockingQueue<Map<String, String>> evidenceQueue = new LinkedBlockingQueue<>();

    @PostConstruct
    public void startWorker() {
        new Thread(() -> {
            while (true) {
                // 2. æ™ºèƒ½èšåˆï¼šè‡ªåŠ¨å°†å¤šæ¡é›¶æ•£æ•°æ®æ‰“åŒ…æˆä¸€ä¸ª Batch
                List<Map<String, String>> batch = new ArrayList<>();
                evidenceQueue.drainTo(batch, 99); // æ¯æ¬¡æœ€å¤šå¤„ç†99æ¡
                
                if (!batch.isEmpty()) {
                     // 3. æ‰¹é‡æäº¤ï¼šä¸€æ¬¡å…±è¯†ï¼Œå­˜å‚¨å¤šæ¡è¯æ®
                    processBatchTransaction(batch);
                }
            }
        }).start();
    }
}
```
3. æŠ€æœ¯ç‚¹ï¼šæ•°æ®å¯é æ€§ä¸é›¶ä¸¢å¤±ä¿éšœ
å•†ä¸šè®¡åˆ’ä¹¦å¯¹åº”ï¼šâ€œå»ºç«‹ç¨³å›ºçš„ç½‘ç»œå®‰å…¨é˜²æŠ¤ä½“ç³»...æä¾›å¯é çš„å®¡è®¡é“¾æ¡â€ã€‚ ä»£ç å®ç°ï¼šè®¾è®¡äº† ç†”æ–­é‡è¯• (Fallback) æœºåˆ¶ã€‚å½“åŒºå—é“¾ç½‘ç»œæ‹¥å µæˆ–å‘ç”Ÿå†²çªæ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨é™çº§ï¼Œç¡®ä¿å…³é”®çš„å¨èƒæƒ…æŠ¥æ•°æ®ä¸ä¸¢å¤±ã€‚

ä»£ç è¯æ®ï¼šç†”æ–­é‡è¯•é€»è¾‘ (æ¥æºï¼šsrc/main/java/com/example/blockchain/service/AsyncService.java)

Java

```java
private void processBatchTransaction(List<Map<String, String>> batch) {
    try {
        // å°è¯•æ‰¹é‡ä¸Šé“¾
        contract.submitTransaction("submitEvidenceBatch", batchJson);
    } catch (Exception e) {
        System.err.println("âŒ [å¤±è´¥] ä¸Šé“¾å¼‚å¸¸: " + e.getMessage());
        
        // --- æ ¸å¿ƒå®¹é”™é€»è¾‘ï¼šç†”æ–­é‡è¯• ---
        System.out.println("âš ï¸ [Fallback] è§¦å‘ç†”æ–­é‡è¯•æœºåˆ¶ï¼Œå°†æ‰“æ•£é‡è¯•...");
        
        for (Map<String, String> item : batch) {
            // æ£€æŸ¥é‡è¯•æ¬¡æ•°ï¼Œé˜²æ­¢æ­»å¾ªç¯
            int retry = Integer.parseInt(item.getOrDefault("retryCount", "0"));
            if (retry < MAX_RETRY) {
                item.put("retryCount", String.valueOf(retry + 1));
                // é‡æ–°æ”¾å…¥é˜Ÿåˆ—å¤´éƒ¨ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å¤„ç†
                evidenceQueue.offer(item); 
            } else {
                // è®°å½•æœ€ç»ˆå¤±è´¥æ—¥å¿—ï¼ˆå®¡è®¡ç”¨ï¼‰
                System.err.println("-> ğŸ’€ ID: " + item.get("eventID") + " å½»åº•å¤±è´¥");
            }
        }
    }
}
```
4. æŠ€æœ¯ç‚¹ï¼šæ•°æ®å®Œæ•´æ€§æ ¡éªŒä¸é˜²ç¯¡æ”¹
å•†ä¸šè®¡åˆ’ä¹¦å¯¹åº”ï¼šâ€œåŒºå—é“¾æŠ€æœ¯é˜²æ­¢ç¯¡æ”¹...ç¡®ä¿æ•°æ®çœŸå®æ€§â€ã€‚ ä»£ç å®ç°ï¼šå®ç°äº†åŸºäºå¯†ç å­¦å“ˆå¸Œçš„æ ¡éªŒæ¥å£ã€‚ç³»ç»Ÿå¯¹æ¯”â€œé“¾ä¸ŠæŒ‡çº¹â€ä¸â€œæœ¬åœ°æ•°æ®æŒ‡çº¹â€ï¼Œç›´è§‚å±•ç¤ºæ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ã€‚

ä»£ç è¯æ®ï¼šé˜²ç¯¡æ”¹æ ¡éªŒæ¥å£ (æ¥æºï¼šsrc/main/java/com/example/blockchain/BlockchainController.java)

Java

```java
@PostMapping("/verify")
public Map<String, Object> verifyEvidence(@RequestBody Map<String, String> payload) {
    // 1. è·å–ä¸šåŠ¡ç«¯ä¼ æ¥çš„æœ¬åœ°å“ˆå¸Œ
    String clientHash = payload.get("dataHash");
    
    // 2. ä»åŒºå—é“¾è´¦æœ¬ä¸­è¯»å–ä¸å¯ç¯¡æ”¹çš„å“ˆå¸Œ
    byte[] result = contract.evaluateTransaction("getEvidenceByEventID", id);
    JSONObject chainData = JSON.parseObject(new String(result, StandardCharsets.UTF_8));
    String chainHash = chainData.getString("dataHash");

    // 3. å¯†ç å­¦æ¯”å¯¹ï¼šéªŒè¯æ•°æ®å®Œæ•´æ€§
    boolean isMatch = chainHash.equals(clientHash);
    
    response.put("isMatch", isMatch); // è¿”å› true/false
    return response;
}
```
