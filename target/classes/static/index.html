<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒºå—é“¾å®‰å…¨å­˜è¯ç³»ç»Ÿ - ç»¼åˆè°ƒè¯•æ§åˆ¶å°</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #c0392b; --light: #ecf0f1; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f4f6f7; margin: 0; padding: 20px; color: #333; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        
        /* å¸ƒå±€ */
        .left-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .right-panel { flex: 1; background: #1e1e1e; color: #0f0; border-radius: 8px; padding: 15px; font-family: 'Consolas', monospace; display: flex; flex-direction: column; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 2px solid var(--light); padding-bottom: 10px; color: var(--primary); font-size: 1.2em; display: flex; align-items: center; justify-content: space-between; }
        
        /* è¡¨å•å…ƒç´  */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #7f8c8d; font-size: 0.9em; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { resize: vertical; min-height: 80px; font-family: monospace; font-size: 0.9em; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        /* æŒ‰é’® */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #219150; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-outline { background: transparent; border: 1px solid #bdc3c7; color: #7f8c8d; }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

        /* å¿«æ·æ ‡ç­¾ */
        .tags { display: flex; gap: 5px; margin-bottom: 10px; }
        .tag { background: #eef2f3; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; cursor: pointer; color: #555; }
        .tag:hover { background: #dfe6e9; color: var(--accent); }

        /* æ—¥å¿—ç»ˆç«¯ */
        #log-container { flex: 1; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; line-height: 1.4; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #333; padding-bottom: 4px; }
        .log-time { color: #888; margin-right: 10px; }
        .log-method { color: #e67e22; font-weight: bold; }
        .log-url { color: #3498db; }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        
        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 0.9em; display: inline-block; width: 100%; text-align: center; box-sizing: border-box;}
        .status-match { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-mismatch { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

    <div class="left-panel">
        
        <div class="card">
            <h2>
                ğŸ“ æ•°æ®ä¸Šé“¾ (Write)
                <span style="font-size: 0.8em; color: #999;">å¼‚æ­¥é˜Ÿåˆ— + æ‰¹é‡æ‰“åŒ…</span>
            </h2>
            
            <div class="tags">
                <span class="tag" onclick="fillTemplate('RULE')">ğŸ›¡ï¸ å®‰å…¨è§„åˆ™</span>
                <span class="tag" onclick="fillTemplate('FLOW')">ğŸŒŠ ç½‘ç»œæµé‡</span>
                <span class="tag" onclick="fillTemplate('ALERT')">ğŸš¨ å¨èƒå‘Šè­¦</span>
                <span class="tag" onclick="fillTemplate('USER')">ğŸ‘¤ ç»„ç»‡ä¿¡æ¯</span>
            </div>

            <div class="form-group">
                <label>äº‹ä»¶ID (Event ID)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="w-id" placeholder="å…¨å±€å”¯ä¸€ID">
                    <button class="btn-outline" style="flex: 0 0 80px;" onclick="genRandomID()">ğŸ² éšæœº</button>
                </div>
            </div>
            <div class="form-group">
                <label>æ•°æ®å“ˆå¸Œ (Data Hash / Fingerprint)</label>
                <input type="text" id="w-hash" placeholder="SHA256 æ‘˜è¦">
            </div>
            <div class="form-group">
                <label>ä¸šåŠ¡æ•°æ® (Metadata - JSON)</label>
                <textarea id="w-meta" placeholder="åœ¨æ­¤è¾“å…¥ä¸šåŠ¡è¯¦æƒ… JSON..."></textarea>
            </div>
            <div class="btn-group">
                <button class="btn-primary" onclick="submitEvidence()">ğŸš€ ç«‹å³ä¸Šé“¾</button>
                <button class="btn-warning" onclick="stressTest()">ğŸ”¥ å‹åŠ›æµ‹è¯• (è¿å‘10æ¡)</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ” æŸ¥è¯¢ä¸æ ¡éªŒ (Query & Verify)</h2>
            <div class="form-group">
                <label>ç›®æ ‡ ID</label>
                <input type="text" id="q-id" placeholder="è¾“å…¥è¦æŸ¥è¯¢çš„ Event ID">
            </div>
            <div class="btn-group">
                <button class="btn-outline" onclick="queryEvidence()">ğŸ“„ æŸ¥è¯¢è¯¦æƒ…</button>
                <button class="btn-success" onclick="verifyEvidence()">ğŸ›¡ï¸ æ ¡éªŒå“ˆå¸Œä¸€è‡´æ€§</button>
            </div>
            
            <div id="verify-result" style="margin-top: 15px; display: none;">
                <div class="status-badge" id="verify-badge"></div>
                <div style="margin-top:10px; font-size: 0.85em; display: grid; grid-template-columns: 80px 1fr; gap: 5px;">
                    <div>é“¾ä¸ŠHash:</div><div id="v-chain-hash" style="font-family: monospace;"></div>
                    <div>æœ¬åœ°Hash:</div><div id="v-local-hash" style="font-family: monospace;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <span>ğŸ“º äº¤äº’æ—¥å¿— (Console)</span>
            <button style="background:none; border:1px solid #555; color:#888; padding: 2px 8px; font-size:0.8em;" onclick="clearLog()">æ¸…ç©º</button>
        </div>
        <div id="log-container">
            <div class="log-entry">ç³»ç»Ÿå°±ç»ªã€‚ç­‰å¾…æ“ä½œ...<br>API åœ°å€: http://localhost:8080/api</div>
        </div>
    </div>

<script>
    const API = 'http://localhost:8080/api';

    // --- 1. è¾…åŠ©åŠŸèƒ½ ---
    function genRandomID() {
        const prefix = ['RULE', 'FLOW', 'ALERT', 'USER'][Math.floor(Math.random()*4)];
        const rand = Math.floor(Math.random() * 100000);
        document.getElementById('w-id').value = `${prefix}_${Date.now()}_${rand}`;
        // è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªä¼ªå“ˆå¸Œ
        document.getElementById('w-hash').value = "hash_" + Math.random().toString(36).substring(2);
    }

    function fillTemplate(type) {
        let meta = {};
        if(type === 'RULE') {
            meta = { type: "RULE", action: "deny", proto: "tcp", src_port: 22, desc: "ç¦æ­¢SSHæš´åŠ›ç ´è§£" };
            document.getElementById('w-id').value = `RULE_${Date.now()}`;
        } else if(type === 'FLOW') {
            meta = { type: "FLOW", src: "192.168.1.5", dst: "10.0.0.1", bytes: 1024, duration: 5.2 };
            document.getElementById('w-id').value = `FLOW_${Date.now()}`;
        } else if(type === 'ALERT') {
            meta = { type: "ALERT", level: "High", attack_type: "SQL Injection", target: "/login" };
            document.getElementById('w-id').value = `ALERT_${Date.now()}`;
        } else {
            meta = { type: "USER", role: "admin", dept: "Security Center", user: "sam" };
            document.getElementById('w-id').value = `USER_${Date.now()}`;
        }
        document.getElementById('w-meta').value = JSON.stringify(meta, null, 2);
        document.getElementById('w-hash').value = "h_" + Math.random().toString(36).substring(7); // æ¨¡æ‹Ÿå“ˆå¸Œ
        log(`[æ¨¡æ¿] å·²å¡«å…… ${type} ç±»å‹æ¨¡æ¿æ•°æ®`);
    }

    function log(msg, type='info') {
        const box = document.getElementById('log-container');
        const time = new Date().toLocaleTimeString();
        let color = type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : '');
        
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span class="log-time">[${time}]</span> <span class="${color}">${msg}</span>`;
        box.prepend(div);
    }

    function clearLog() { document.getElementById('log-container').innerHTML = ''; }

    // --- 2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

    // ä¸Šé“¾
    async function submitEvidence() {
        const id = document.getElementById('w-id').value;
        const hash = document.getElementById('w-hash').value;
        const meta = document.getElementById('w-meta').value;

        if(!id) return alert("è¯·å…ˆå¡«å†™äº‹ä»¶ID");

        log(`>>> å‘èµ·ä¸Šé“¾è¯·æ±‚: ${id}`, 'info');
        
        try {
            const res = await fetch(`${API}/evidence`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ eventID: id, dataHash: hash, metadata: meta })
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                log(`âœ… [åç«¯è¿”å›] ${data.message}`, 'success');
                // è‡ªåŠ¨æŠŠIDå¡«å…¥æŸ¥è¯¢æ¡†ï¼Œæ–¹ä¾¿éªŒè¯
                document.getElementById('q-id').value = id;
            } else {
                log(`âŒ [é”™è¯¯] ${data.message}`, 'error');
            }
        } catch(e) {
            log(`âŒ [ç½‘ç»œå¼‚å¸¸] ${e}`, 'error');
        }
    }

    // å‹åŠ›æµ‹è¯• (è¿å‘)
    async function stressTest() {
        const baseId = `BATCH_${Date.now()}`;
        log(`ğŸ”¥ å¼€å§‹å‹åŠ›æµ‹è¯•ï¼Œè¿å‘ 10 æ¡æ•°æ® (å‰ç¼€: ${baseId})...`, 'info');
        
        for(let i=1; i<=10; i++) {
            const id = `${baseId}_${i}`;
            const payload = {
                eventID: id,
                dataHash: `hash_test_${i}`,
                metadata: JSON.stringify({ type: "STRESS_TEST", index: i })
            };
            
            // ä¸ç­‰å¾… awaitï¼Œæ¨¡æ‹Ÿé«˜å¹¶å‘
            fetch(`${API}/evidence`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(res => res.json()).then(data => {
                log(`   -> [${i}/10] å‘é€æˆåŠŸ: ${id}`, 'success');
            });
        }
        log(`â³ 10æ¡è¯·æ±‚å·²å…¨éƒ¨å‘å‡ºï¼Œè¯·è§‚å¯Ÿåç«¯æ§åˆ¶å°çš„â€œæ‰¹é‡æ‰“åŒ…â€æ—¥å¿—ï¼`);
    }

    // æŸ¥è¯¢
    async function queryEvidence() {
        const id = document.getElementById('q-id').value;
        if(!id) return alert("è¯·è¾“å…¥ID");

        log(`>>> æŸ¥è¯¢é“¾ä¸Šæ•°æ®: ${id}...`);
        try {
            const res = await fetch(`${API}/evidence/${id}`);
            const data = await res.json();
            if(data.status === 'success') {
                log(`ğŸ“„ [æŸ¥è¯¢ç»“æœ] \n${JSON.stringify(data.data, null, 2)}`);
            } else {
                log(`âš ï¸ [æŸ¥è¯¢å¤±è´¥] ${data.message}`, 'error');
            }
        } catch(e) { log(`âŒ ${e}`, 'error'); }
    }

    // æ ¡éªŒ
    async function verifyEvidence() {
        const id = document.getElementById('q-id').value;
        // æ¨¡æ‹Ÿï¼šä»å·¦è¾¹è¾“å…¥æ¡†è·å–â€œæœ¬åœ°Hashâ€ï¼Œå¦‚æœæ²¡å¡«å°±ç”¨â€œmockâ€
        const localHash = document.getElementById('w-hash').value || "mock_tampered_hash";
        
        if(!id) return alert("è¯·è¾“å…¥ID");

        log(`>>> è¯·æ±‚æ ¡éªŒ API... (ID: ${id})`);
        try {
            const res = await fetch(`${API}/verify`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ eventID: id, dataHash: localHash })
            });
            const data = await res.json();
            
            const resBox = document.getElementById('verify-result');
            const badge = document.getElementById('verify-badge');
            
            resBox.style.display = 'block';
            document.getElementById('v-chain-hash').innerText = data.chainHash || "æœªæ‰¾åˆ°";
            document.getElementById('v-local-hash').innerText = localHash;

            if(data.isMatch) {
                badge.className = 'status-badge status-match';
                badge.innerText = 'âœ… å“ˆå¸Œä¸€è‡´ (æ•°æ®æœªç¯¡æ”¹)';
                log(`âœ… æ ¡éªŒé€šè¿‡ï¼`, 'success');
            } else {
                badge.className = 'status-badge status-mismatch';
                badge.innerText = 'âŒ å“ˆå¸Œä¸åŒ¹é… (æ•°æ®å¯èƒ½è¢«ç¯¡æ”¹)';
                log(`âŒ æ ¡éªŒå¤±è´¥ï¼é“¾ä¸ŠHashä¸æœ¬åœ°ä¸ç¬¦ã€‚`, 'error');
            }
        } catch(e) { log(`âŒ ${e}`, 'error'); }
    }
</script>
</body>
</html>